<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Work Join Toggle</title>
  <style>
    body { font-family: system-ui, Arial; padding: 24px; max-width: 720px; margin: auto; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 18px; margin-bottom: 14px; }
    .row { display:flex; justify-content:space-between; align-items:center; gap: 12px; margin-top: 14px; }
    .status { margin-top: 12px; font-weight: 700; font-size: 18px; }
    .small { color: #666; font-size: 13px; margin-top: 6px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; background:#fff; cursor: pointer; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>Morning Work Check (Live)</h2>

  <div class="card">
    <div><b>Choose who you are (important)</b></div>
    <div class="small">
      Open as friend: <code>?user=friend</code> &nbsp; | &nbsp;
      Open as you: <code>?user=me</code>
    </div>
    <div class="row">
      <button id="openFriend">Open Friend Link</button>
      <button id="openMe">Open My Link</button>
    </div>
  </div>

  <div class="card">
    <div><b>Your toggle</b></div>
    <div class="row">
      <div id="who"></div>
      <input id="toggle" type="checkbox" style="transform: scale(1.4);" />
    </div>
    <div id="myStatus" class="status"></div>
    <div id="myTime" class="small"></div>
  </div>

  <div class="card">
    <div><b>Other person’s status (live)</b></div>
    <div id="otherStatus" class="status">Loading…</div>
    <div id="otherTime" class="small"></div>
  </div>

  <!-- Firebase (Modular SDK) -->
  <script type="module">
    // 1) Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // 
    const firebaseConfig = {
      // apiKey: "...",
      // authDomain: "...",
      // projectId: "...",
    };

    // 3) Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 4) Identify who is using the page (friend or me)
    const params = new URLSearchParams(window.location.search);
    const user = (params.get("user") || "friend").toLowerCase(); // default friend
    const validUser = (user === "friend" || user === "me") ? user : "friend";

    const whoEl = document.getElementById("who");
    whoEl.textContent = validUser === "friend" ? "You are: FRIEND" : "You are: ME (viewer)";

    // Quick buttons to generate correct links
    const base = window.location.origin + window.location.pathname;
    document.getElementById("openFriend").onclick = () => window.location.href = base + "?user=friend";
    document.getElementById("openMe").onclick = () => window.location.href = base + "?user=me";

    // 5) UI elements
    const toggle = document.getElementById("toggle");
    const myStatus = document.getElementById("myStatus");
    const myTime = document.getElementById("myTime");
    const otherStatus = document.getElementById("otherStatus");
    const otherTime = document.getElementById("otherTime");

    // 6) Firestore document paths
    const myDoc = doc(db, "workStatus", validUser);
    const otherUser = validUser === "friend" ? "me" : "friend";
    const otherDoc = doc(db, "workStatus", otherUser);

    function formatTime(ts) {
      if (!ts) return "";
      const d = ts.toDate();
      return "Last updated: " + d.toLocaleString();
    }

    function renderStatus(el, joining) {
      if (joining === true) {
        el.textContent = "✅ YES — joining";
        el.style.color = "green";
      } else if (joining === false) {
        el.textContent = "❌ NO — not joining";
        el.style.color = "crimson";
      } else {
        el.textContent = "— No update yet —";
        el.style.color = "#333";
      }
    }

    // 7) Listen for MY status (so toggle matches database)
    onSnapshot(myDoc, (snap) => {
      const data = snap.exists() ? snap.data() : {};
      const joining = data.joining;
      toggle.checked = joining === true;
      renderStatus(myStatus, joining);
      myTime.textContent = formatTime(data.updatedAt);
    });

    // 8) Listen for OTHER status (live on your screen)
    onSnapshot(otherDoc, (snap) => {
      const data = snap.exists() ? snap.data() : {};
      renderStatus(otherStatus, data.joining);
      otherTime.textContent = formatTime(data.updatedAt);
    });

    // 9) When YOU toggle, write to Firestore
    toggle.addEventListener("change", async () => {
      await setDoc(myDoc, {
        joining: toggle.checked,
        updatedAt: serverTimestamp()
      }, { merge: true });
    });
  </script>
</body>
</html>

